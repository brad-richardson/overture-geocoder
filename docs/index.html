<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overture Geocoder</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåç</text></svg>">

  <!-- MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />

  <!-- PMTiles Protocol -->
  <script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #0a0a0a;
      color: #fff;
      height: 100vh;
      overflow: hidden;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .control-panel {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 1000;
      background: rgba(10, 10, 10, 0.92);
      backdrop-filter: blur(12px);
      border-radius: 12px;
      padding: 20px;
      width: 360px;
      max-height: calc(100vh - 32px);
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo h1 {
      font-size: 18px;
      font-weight: 600;
      background: linear-gradient(135deg, #fff, #a5b4fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 4px;
    }

    .tab {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.6);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .tab:hover {
      color: rgba(255, 255, 255, 0.8);
    }

    .tab.active {
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      color: #fff;
    }

    .search-container {
      position: relative;
      margin-bottom: 12px;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      padding-left: 44px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
    }

    .search-input:focus {
      border-color: #3b82f6;
      background: rgba(255, 255, 255, 0.1);
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.4);
      pointer-events: none;
    }

    .coords-container {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .coord-input-group {
      flex: 1;
    }

    .coord-label {
      display: block;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .coord-input {
      width: 100%;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
    }

    .coord-input:focus {
      border-color: #3b82f6;
      background: rgba(255, 255, 255, 0.1);
    }

    .search-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .search-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .search-btn:active {
      transform: translateY(0);
    }

    .search-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .hint {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .results {
      margin-top: 16px;
    }

    .results-header {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .result-item {
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .result-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .result-name {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #fff;
    }

    .result-meta {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .result-type {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      background: rgba(99, 102, 241, 0.2);
      border-radius: 4px;
      font-size: 11px;
      color: #a5b4fc;
      text-transform: capitalize;
    }

    .result-coords {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
    }

    .hierarchy {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .hierarchy-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      padding: 2px 0;
    }

    .hierarchy-item::before {
      content: '‚Ä∫';
      color: rgba(255, 255, 255, 0.3);
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      color: rgba(255, 255, 255, 0.5);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      color: #fca5a5;
      font-size: 13px;
    }

    .empty-state {
      text-align: center;
      padding: 24px;
      color: rgba(255, 255, 255, 0.4);
      font-size: 13px;
    }

    .maplibregl-popup {
      max-width: 280px;
    }

    .maplibregl-popup-content {
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(12px);
      border-radius: 8px;
      padding: 12px;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .maplibregl-popup-close-button {
      color: rgba(255, 255, 255, 0.6);
      font-size: 18px;
      padding: 4px 8px;
    }

    .maplibregl-popup-close-button:hover {
      color: #fff;
      background: transparent;
    }

    .maplibregl-popup-tip {
      border-top-color: rgba(10, 10, 10, 0.95);
    }

    .popup-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .popup-type {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(99, 102, 241, 0.2);
      border-radius: 4px;
      font-size: 11px;
      color: #a5b4fc;
      text-transform: capitalize;
      margin-bottom: 6px;
    }

    .popup-coords {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
    }

    .info-panel {
      position: absolute;
      bottom: 16px;
      left: 16px;
      z-index: 1000;
      background: rgba(10, 10, 10, 0.9);
      backdrop-filter: blur(8px);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-panel a {
      color: #818cf8;
      text-decoration: none;
    }

    .info-panel a:hover {
      text-decoration: underline;
    }

    @media (max-width: 480px) {
      .control-panel {
        left: 8px;
        right: 8px;
        width: auto;
        max-height: 50vh;
      }

      .info-panel {
        right: 8px;
        left: 8px;
        bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="control-panel">
    <div class="logo">
      <div class="logo-icon">O</div>
      <h1>Overture Geocoder</h1>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="forward">Forward</button>
      <button class="tab" data-tab="reverse">Reverse</button>
    </div>

    <div id="forward-panel">
      <div class="search-container">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" class="search-input" id="search-input" placeholder="Search for a place..." autocomplete="off">
      </div>
      <div class="hint">
        <span>Press Enter or click Search</span>
      </div>
      <button class="search-btn" id="search-btn">Search</button>
    </div>

    <div id="reverse-panel" style="display: none;">
      <div class="coords-container">
        <div class="coord-input-group">
          <label class="coord-label">Latitude</label>
          <input type="number" class="coord-input" id="lat-input" placeholder="42.3601" step="any">
        </div>
        <div class="coord-input-group">
          <label class="coord-label">Longitude</label>
          <input type="number" class="coord-input" id="lon-input" placeholder="-71.0589" step="any">
        </div>
      </div>
      <div class="hint">
        <span>Click on map or enter coordinates</span>
      </div>
      <button class="search-btn" id="reverse-btn">Lookup Location</button>
    </div>

    <div id="results" class="results"></div>
  </div>

  <div class="info-panel">
    Powered by <a href="https://overturemaps.org" target="_blank">Overture Maps</a>
    &bull;
    <a href="https://github.com/brad-richardson/overture-geocoder" target="_blank">GitHub</a>
  </div>

  <script>
    // API Configuration
    const API_BASE_URL = 'https://overture-geocoder.bradr.workers.dev';

    // PMTiles URLs from Overture Maps
    const PMTILES_SOURCES = {
      base: 'https://d3c1b7bog2u1nn.cloudfront.net/2025-12-17/base.pmtiles',
      buildings: 'https://d3c1b7bog2u1nn.cloudfront.net/2025-12-17/buildings.pmtiles',
      transportation: 'https://d3c1b7bog2u1nn.cloudfront.net/2025-12-17/transportation.pmtiles',
      divisions: 'https://d3c1b7bog2u1nn.cloudfront.net/2025-12-17/divisions.pmtiles'
    };

    // Register PMTiles protocol
    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol('pmtiles', protocol.tile);

    // Initialize map
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
        sources: {
          'overture-base': {
            type: 'vector',
            url: `pmtiles://${PMTILES_SOURCES.base}`
          },
          'overture-buildings': {
            type: 'vector',
            url: `pmtiles://${PMTILES_SOURCES.buildings}`
          },
          'overture-transportation': {
            type: 'vector',
            url: `pmtiles://${PMTILES_SOURCES.transportation}`
          },
          'overture-divisions': {
            type: 'vector',
            url: `pmtiles://${PMTILES_SOURCES.divisions}`
          }
        },
        layers: [
          // Background
          {
            id: 'background',
            type: 'background',
            paint: {
              'background-color': '#0a0a0a'
            }
          },
          // Water
          {
            id: 'water',
            type: 'fill',
            source: 'overture-base',
            'source-layer': 'water',
            paint: {
              'fill-color': '#1a1a2e'
            }
          },
          // Land
          {
            id: 'land',
            type: 'fill',
            source: 'overture-base',
            'source-layer': 'land',
            paint: {
              'fill-color': '#141414'
            }
          },
          // Land use
          {
            id: 'landuse',
            type: 'fill',
            source: 'overture-base',
            'source-layer': 'land_use',
            paint: {
              'fill-color': [
                'match',
                ['get', 'subtype'],
                'park', '#0d1f0d',
                'forest', '#0a1a0a',
                'residential', '#181818',
                'commercial', '#1a1818',
                'industrial', '#1a1a18',
                '#161616'
              ],
              'fill-opacity': 0.7
            }
          },
          // Transportation - minor roads
          {
            id: 'roads-minor',
            type: 'line',
            source: 'overture-transportation',
            'source-layer': 'segment',
            filter: ['in', ['get', 'subtype'], ['literal', ['residential', 'service', 'track', 'path']]],
            paint: {
              'line-color': '#2a2a2a',
              'line-width': [
                'interpolate', ['linear'], ['zoom'],
                12, 0.5,
                16, 2
              ]
            },
            minzoom: 12
          },
          // Transportation - major roads
          {
            id: 'roads-major',
            type: 'line',
            source: 'overture-transportation',
            'source-layer': 'segment',
            filter: ['in', ['get', 'subtype'], ['literal', ['primary', 'secondary', 'tertiary']]],
            paint: {
              'line-color': '#3a3a3a',
              'line-width': [
                'interpolate', ['linear'], ['zoom'],
                8, 0.5,
                14, 3,
                18, 8
              ]
            },
            minzoom: 8
          },
          // Transportation - highways
          {
            id: 'roads-highway',
            type: 'line',
            source: 'overture-transportation',
            'source-layer': 'segment',
            filter: ['in', ['get', 'subtype'], ['literal', ['motorway', 'trunk']]],
            paint: {
              'line-color': '#4a4a4a',
              'line-width': [
                'interpolate', ['linear'], ['zoom'],
                5, 0.5,
                10, 2,
                16, 6
              ]
            },
            minzoom: 5
          },
          // Buildings
          {
            id: 'buildings',
            type: 'fill',
            source: 'overture-buildings',
            'source-layer': 'building',
            paint: {
              'fill-color': '#1f1f1f',
              'fill-opacity': 0.8
            },
            minzoom: 13
          },
          // Building outlines
          {
            id: 'buildings-outline',
            type: 'line',
            source: 'overture-buildings',
            'source-layer': 'building',
            paint: {
              'line-color': '#2a2a2a',
              'line-width': 0.5
            },
            minzoom: 15
          },
          // Division boundaries
          {
            id: 'division-boundaries',
            type: 'line',
            source: 'overture-divisions',
            'source-layer': 'division_boundary',
            paint: {
              'line-color': '#3b82f6',
              'line-width': [
                'interpolate', ['linear'], ['zoom'],
                3, 0.5,
                10, 1.5
              ],
              'line-opacity': 0.4,
              'line-dasharray': [2, 2]
            },
            minzoom: 3
          },
          // Place labels
          {
            id: 'place-labels',
            type: 'symbol',
            source: 'overture-divisions',
            'source-layer': 'division',
            filter: ['in', ['get', 'subtype'], ['literal', ['locality', 'county', 'region']]],
            layout: {
              'text-field': ['coalesce', ['get', 'primary_name'], ['get', 'name']],
              'text-size': [
                'interpolate', ['linear'], ['zoom'],
                5, 10,
                12, 14
              ],
              'text-anchor': 'center',
              'text-max-width': 8
            },
            paint: {
              'text-color': 'rgba(255, 255, 255, 0.7)',
              'text-halo-color': 'rgba(0, 0, 0, 0.8)',
              'text-halo-width': 1.5
            },
            minzoom: 5
          }
        ]
      },
      center: [-71.0589, 42.3601], // Boston
      zoom: 10,
      maxZoom: 18
    });

    // Add navigation controls
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // State
    let currentTab = 'forward';
    let markers = [];
    let popup = null;

    // DOM Elements
    const tabs = document.querySelectorAll('.tab');
    const forwardPanel = document.getElementById('forward-panel');
    const reversePanel = document.getElementById('reverse-panel');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const latInput = document.getElementById('lat-input');
    const lonInput = document.getElementById('lon-input');
    const reverseBtn = document.getElementById('reverse-btn');
    const resultsContainer = document.getElementById('results');

    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        currentTab = tab.dataset.tab;
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        if (currentTab === 'forward') {
          forwardPanel.style.display = 'block';
          reversePanel.style.display = 'none';
        } else {
          forwardPanel.style.display = 'none';
          reversePanel.style.display = 'block';
        }

        clearResults();
        clearMarkers();
      });
    });

    // Forward geocoding
    async function forwardGeocode(query) {
      showLoading();
      clearMarkers();

      try {
        const params = new URLSearchParams({
          q: query,
          format: 'jsonv2',
          limit: '10'
        });

        const response = await fetch(`${API_BASE_URL}/search?${params}`);

        if (!response.ok) {
          throw new Error(`Request failed: ${response.status}`);
        }

        const data = await response.json();
        displayForwardResults(data);

        if (data.length > 0) {
          addMarkers(data);
          fitBounds(data);
        }
      } catch (error) {
        showError(error.message);
      }
    }

    // Reverse geocoding
    async function reverseGeocode(lat, lon) {
      showLoading();
      clearMarkers();

      try {
        const params = new URLSearchParams({
          lat: String(lat),
          lon: String(lon),
          format: 'jsonv2'
        });

        const response = await fetch(`${API_BASE_URL}/reverse?${params}`);

        if (!response.ok) {
          throw new Error(`Request failed: ${response.status}`);
        }

        const data = await response.json();
        displayReverseResults(data, lat, lon);

        // Add marker for the searched location
        addClickMarker(lat, lon);

        if (data.length > 0) {
          // Zoom to show the results
          const bounds = new maplibregl.LngLatBounds();
          bounds.extend([lon, lat]);
          data.forEach(r => {
            bounds.extend([r.lon, r.lat]);
          });
          map.fitBounds(bounds, { padding: 100, maxZoom: 14 });
        }
      } catch (error) {
        showError(error.message);
      }
    }

    // Display forward geocoding results
    function displayForwardResults(results) {
      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="empty-state">No results found</div>';
        return;
      }

      let html = '<div class="results-header">Results</div>';

      results.forEach((result, index) => {
        html += `
          <div class="result-item" data-index="${index}" data-lat="${result.lat}" data-lon="${result.lon}">
            <div class="result-name">${escapeHtml(result.primary_name)}</div>
            <div class="result-meta">
              <span class="result-type">${result.type || 'place'}</span>
              <span class="result-coords">${result.lat.toFixed(5)}, ${result.lon.toFixed(5)}</span>
            </div>
          </div>
        `;
      });

      resultsContainer.innerHTML = html;

      // Add click handlers
      document.querySelectorAll('.result-item').forEach(item => {
        item.addEventListener('click', () => {
          const lat = parseFloat(item.dataset.lat);
          const lon = parseFloat(item.dataset.lon);
          map.flyTo({ center: [lon, lat], zoom: 14 });

          // Show popup
          if (popup) popup.remove();
          const result = results[parseInt(item.dataset.index)];
          popup = new maplibregl.Popup()
            .setLngLat([lon, lat])
            .setHTML(`
              <div class="popup-title">${escapeHtml(result.primary_name)}</div>
              <div class="popup-type">${result.type || 'place'}</div>
              <div class="popup-coords">${lat.toFixed(5)}, ${lon.toFixed(5)}</div>
            `)
            .addTo(map);
        });
      });
    }

    // Display reverse geocoding results
    function displayReverseResults(results, searchLat, searchLon) {
      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="empty-state">No results found at this location</div>';
        return;
      }

      let html = '<div class="results-header">Location Hierarchy</div>';

      results.forEach((result, index) => {
        html += `
          <div class="result-item" data-index="${index}" data-lat="${result.lat}" data-lon="${result.lon}">
            <div class="result-name">${escapeHtml(result.primary_name)}</div>
            <div class="result-meta">
              <span class="result-type">${result.subtype}</span>
              <span class="result-coords">${result.distance_km.toFixed(2)} km</span>
            </div>
            ${result.hierarchy ? `
              <div class="hierarchy">
                ${result.hierarchy.map(h => `
                  <div class="hierarchy-item">${escapeHtml(h.name)} (${h.subtype})</div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      });

      resultsContainer.innerHTML = html;

      // Add click handlers
      document.querySelectorAll('.result-item').forEach(item => {
        item.addEventListener('click', () => {
          const lat = parseFloat(item.dataset.lat);
          const lon = parseFloat(item.dataset.lon);
          map.flyTo({ center: [lon, lat], zoom: 12 });
        });
      });
    }

    // Add markers for results
    function addMarkers(results) {
      results.forEach((result, index) => {
        const el = document.createElement('div');
        el.className = 'marker';
        el.style.cssText = `
          width: 24px;
          height: 24px;
          background: linear-gradient(135deg, #3b82f6, #6366f1);
          border-radius: 50%;
          border: 2px solid #fff;
          box-shadow: 0 2px 8px rgba(0,0,0,0.4);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #fff;
          font-size: 11px;
          font-weight: 600;
        `;
        el.textContent = index + 1;

        const marker = new maplibregl.Marker({ element: el })
          .setLngLat([result.lon, result.lat])
          .addTo(map);

        el.addEventListener('click', () => {
          if (popup) popup.remove();
          popup = new maplibregl.Popup()
            .setLngLat([result.lon, result.lat])
            .setHTML(`
              <div class="popup-title">${escapeHtml(result.primary_name)}</div>
              <div class="popup-type">${result.type || result.subtype || 'place'}</div>
              <div class="popup-coords">${result.lat.toFixed(5)}, ${result.lon.toFixed(5)}</div>
            `)
            .addTo(map);
        });

        markers.push(marker);
      });
    }

    // Add click marker for reverse geocoding
    function addClickMarker(lat, lon) {
      const el = document.createElement('div');
      el.style.cssText = `
        width: 20px;
        height: 20px;
        background: #ef4444;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      `;

      const marker = new maplibregl.Marker({ element: el })
        .setLngLat([lon, lat])
        .addTo(map);

      markers.push(marker);
    }

    // Fit map bounds to results
    function fitBounds(results) {
      if (results.length === 0) return;

      const bounds = new maplibregl.LngLatBounds();
      results.forEach(r => {
        bounds.extend([r.lon, r.lat]);
      });

      map.fitBounds(bounds, { padding: 100, maxZoom: 14 });
    }

    // Clear markers
    function clearMarkers() {
      markers.forEach(m => m.remove());
      markers = [];
      if (popup) {
        popup.remove();
        popup = null;
      }
    }

    // Clear results
    function clearResults() {
      resultsContainer.innerHTML = '';
    }

    // Show loading state
    function showLoading() {
      resultsContainer.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <span>Searching...</span>
        </div>
      `;
    }

    // Show error
    function showError(message) {
      resultsContainer.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
    }

    // Escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[c]);
    }

    // Event listeners
    searchBtn.addEventListener('click', () => {
      const query = searchInput.value.trim();
      if (query) {
        forwardGeocode(query);
      }
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const query = searchInput.value.trim();
        if (query) {
          forwardGeocode(query);
        }
      }
    });

    reverseBtn.addEventListener('click', () => {
      const lat = parseFloat(latInput.value);
      const lon = parseFloat(lonInput.value);
      if (!isNaN(lat) && !isNaN(lon)) {
        reverseGeocode(lat, lon);
      }
    });

    // Map click for reverse geocoding
    map.on('click', (e) => {
      if (currentTab === 'reverse') {
        const { lat, lng } = e.lngLat;
        latInput.value = lat.toFixed(6);
        lonInput.value = lng.toFixed(6);
        reverseGeocode(lat, lng);
      }
    });

    // Change cursor in reverse mode
    map.on('mousemove', () => {
      if (currentTab === 'reverse') {
        map.getCanvas().style.cursor = 'crosshair';
      } else {
        map.getCanvas().style.cursor = '';
      }
    });
  </script>
</body>
</html>
