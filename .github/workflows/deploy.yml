name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_data_update:
        description: 'Force data update even if release unchanged'
        type: boolean
        default: false
      force_schema_rebuild:
        description: 'Force rebuild with current release (for schema/SQL changes)'
        type: boolean
        default: false
      force_full_rebuild:
        description: 'Force full rebuild (drop + recreate tables with all data)'
        type: boolean
        default: false

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  test:
    uses: ./.github/workflows/ci.yml

  check-release:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      overture_release: ${{ steps.check.outputs.overture_release }}
      prod_release: ${{ steps.check.outputs.prod_release }}
      release_changed: ${{ steps.check.outputs.release_changed }}
      needs_update: ${{ steps.decide.outputs.needs_update }}
      force_full_rebuild: ${{ steps.decide.outputs.force_full_rebuild }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install DuckDB CLI
        run: |
          curl -LO https://github.com/duckdb/duckdb/releases/download/v1.1.3/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          chmod +x duckdb
          sudo mv duckdb /usr/local/bin/

      - name: Check Overture release
        id: check
        run: |
          chmod +x scripts/check_release.sh
          ./scripts/check_release.sh

      - name: Decide if update needed
        id: decide
        run: |
          # Check if force full rebuild requested
          if [ "${{ github.event.inputs.force_full_rebuild }}" = "true" ]; then
            echo "Force full rebuild requested"
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "force_full_rebuild=true" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event.inputs.force_data_update }}" = "true" ] || \
               [ "${{ github.event.inputs.force_schema_rebuild }}" = "true" ]; then
            echo "Force update requested"
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "force_full_rebuild=false" >> "$GITHUB_OUTPUT"
          elif [ "${{ steps.check.outputs.release_changed }}" = "true" ]; then
            echo "Release changed, update needed"
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "force_full_rebuild=false" >> "$GITHUB_OUTPUT"
          else
            echo "No update needed"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            echo "force_full_rebuild=false" >> "$GITHUB_OUTPUT"
          fi

  build-and-diff:
    needs: check-release
    if: needs.check-release.outputs.needs_update == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install DuckDB CLI
        run: |
          curl -LO https://github.com/duckdb/duckdb/releases/download/v1.1.3/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          chmod +x duckdb
          sudo mv duckdb /usr/local/bin/

      - name: Install Python dependencies
        run: pip install duckdb

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install npm dependencies
        run: npm ci

      - name: Download global divisions from Overture
        run: |
          chmod +x scripts/download_divisions.sh
          ./scripts/download_divisions.sh "${{ needs.check-release.outputs.overture_release }}"

      - name: Build divisions indexes
        run: |
          mkdir -p indexes
          python scripts/build_divisions_index.py
          python scripts/build_divisions_reverse_index.py

      - name: Fetch production versions (forward)
        run: |
          chmod +x scripts/fetch_prod_versions.sh
          ./scripts/fetch_prod_versions.sh prod_versions.csv geocoder-divisions-global divisions

      - name: Fetch production versions (reverse)
        run: |
          ./scripts/fetch_prod_versions.sh prod_versions_reverse.csv geocoder-divisions-reverse divisions_reverse

      - name: Generate differential update (forward)
        run: |
          FORCE_ALL_FLAG=""
          if [ "${{ needs.check-release.outputs.force_full_rebuild }}" = "true" ]; then
            FORCE_ALL_FLAG="--force-all"
          fi

          python scripts/diff_and_update.py \
            indexes/divisions-global.db \
            exports/diff \
            --prod-versions prod_versions.csv \
            --release "${{ needs.check-release.outputs.overture_release }}" \
            --table divisions \
            $FORCE_ALL_FLAG

          echo "Forward geocoding diff:"
          cat exports/diff/stats.json

      - name: Generate differential update (reverse)
        run: |
          FORCE_ALL_FLAG=""
          if [ "${{ needs.check-release.outputs.force_full_rebuild }}" = "true" ]; then
            FORCE_ALL_FLAG="--force-all"
          fi

          python scripts/diff_and_update.py \
            indexes/divisions-reverse.db \
            exports/diff-reverse \
            --prod-versions prod_versions_reverse.csv \
            --release "${{ needs.check-release.outputs.overture_release }}" \
            --table divisions_reverse \
            $FORCE_ALL_FLAG

          echo "Reverse geocoding diff:"
          cat exports/diff-reverse/stats.json

      - name: Check if changes exist
        id: changes
        run: |
          # Check forward geocoding changes
          if [ ! -f exports/diff/stats.json ]; then
            echo "Error: stats.json not found"
            exit 1
          fi

          if ! jq -e '.inserts != null and .updates != null and .deletes != null and .unchanged != null' exports/diff/stats.json > /dev/null 2>&1; then
            echo "Error: stats.json missing required fields"
            cat exports/diff/stats.json
            exit 1
          fi

          FWD_INSERTS=$(jq '.inserts' exports/diff/stats.json)
          FWD_UPDATES=$(jq '.updates' exports/diff/stats.json)
          FWD_DELETES=$(jq '.deletes' exports/diff/stats.json)
          FWD_TOTAL=$((FWD_INSERTS + FWD_UPDATES + FWD_DELETES))

          echo "Forward changes: $FWD_TOTAL (inserts: $FWD_INSERTS, updates: $FWD_UPDATES, deletes: $FWD_DELETES)"

          # Check reverse geocoding changes
          REV_INSERTS=$(jq '.inserts' exports/diff-reverse/stats.json)
          REV_UPDATES=$(jq '.updates' exports/diff-reverse/stats.json)
          REV_DELETES=$(jq '.deletes' exports/diff-reverse/stats.json)
          REV_TOTAL=$((REV_INSERTS + REV_UPDATES + REV_DELETES))

          echo "Reverse changes: $REV_TOTAL (inserts: $REV_INSERTS, updates: $REV_UPDATES, deletes: $REV_DELETES)"

          # Set outputs
          if [ "$FWD_TOTAL" -eq 0 ]; then
            echo "has_forward_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_forward_changes=true" >> "$GITHUB_OUTPUT"
          fi

          if [ "$REV_TOTAL" -eq 0 ]; then
            echo "has_reverse_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_reverse_changes=true" >> "$GITHUB_OUTPUT"
          fi

          # Overall has_changes for backwards compatibility
          TOTAL=$((FWD_TOTAL + REV_TOTAL))
          if [ "$TOTAL" -eq 0 ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload diff artifacts (forward)
        if: steps.changes.outputs.has_forward_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: diff-sql
          path: exports/diff/
          retention-days: 1

      - name: Upload diff artifacts (reverse)
        if: steps.changes.outputs.has_reverse_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: diff-sql-reverse
          path: exports/diff-reverse/
          retention-days: 1

      - name: Upload full indexes (for fallback)
        uses: actions/upload-artifact@v4
        with:
          name: divisions-indexes
          path: |
            indexes/divisions-global.db
            indexes/divisions-reverse.db
          retention-days: 1

    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}
      has_forward_changes: ${{ steps.changes.outputs.has_forward_changes }}
      has_reverse_changes: ${{ steps.changes.outputs.has_reverse_changes }}
      force_full_rebuild: ${{ needs.check-release.outputs.force_full_rebuild }}

  apply-updates:
    needs: [check-release, build-and-diff]
    if: needs.build-and-diff.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download diff artifacts (forward)
        if: needs.build-and-diff.outputs.has_forward_changes == 'true'
        uses: actions/download-artifact@v4
        with:
          name: diff-sql
          path: exports/diff/

      - name: Download diff artifacts (reverse)
        if: needs.build-and-diff.outputs.has_reverse_changes == 'true'
        uses: actions/download-artifact@v4
        with:
          name: diff-sql-reverse
          path: exports/diff-reverse/

      - name: Download full indexes (for initial/full rebuild)
        uses: actions/download-artifact@v4
        with:
          name: divisions-indexes
          path: indexes/

      # ==================== FORWARD GEOCODING ====================
      - name: Apply forward geocoding updates
        uses: ./.github/actions/apply-d1-updates
        with:
          database-name: geocoder-divisions-global
          index-path: indexes/divisions-global.db
          diff-path: exports/diff
          table-name: divisions
          force-full-rebuild: ${{ needs.build-and-diff.outputs.force_full_rebuild }}
          has-changes: ${{ needs.build-and-diff.outputs.has_forward_changes }}

      # ==================== REVERSE GEOCODING ====================
      - name: Apply reverse geocoding updates
        uses: ./.github/actions/apply-d1-updates
        with:
          database-name: geocoder-divisions-reverse
          index-path: indexes/divisions-reverse.db
          diff-path: exports/diff-reverse
          table-name: divisions_reverse
          force-full-rebuild: ${{ needs.build-and-diff.outputs.force_full_rebuild }}
          has-changes: ${{ needs.build-and-diff.outputs.has_reverse_changes }}

      # ==================== VERIFY ====================
      - name: Verify updates
        run: |
          echo "Verifying forward geocoding..."
          npx wrangler d1 execute geocoder-divisions-global --remote --command "SELECT * FROM metadata" --json
          echo "Verifying reverse geocoding..."
          npx wrangler d1 execute geocoder-divisions-reverse --remote --command "SELECT * FROM metadata" --json || echo "Reverse database may not exist yet"

  deploy-worker:
    needs: [test, check-release, build-and-diff, apply-updates]
    # Run if: tests passed AND one of:
    #   - No data update needed (check-release says no)
    #   - Data update succeeded (apply-updates ran and succeeded)
    #   - No changes to apply (build-and-diff ran, has_changes=false, apply-updates skipped)
    if: |
      always() &&
      needs.test.result == 'success' &&
      (
        needs.check-release.outputs.needs_update == 'false' ||
        needs.apply-updates.result == 'success' ||
        (needs.build-and-diff.result == 'success' && needs.apply-updates.result == 'skipped')
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Deploy Worker
        run: npx wrangler deploy
