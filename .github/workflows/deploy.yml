name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_data_update:
        description: 'Force data update even if release unchanged'
        type: boolean
        default: false

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  test:
    uses: ./.github/workflows/ci.yml

  check-release:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      overture_release: ${{ steps.check.outputs.overture_release }}
      prod_release: ${{ steps.check.outputs.prod_release }}
      release_changed: ${{ steps.check.outputs.release_changed }}
      needs_update: ${{ steps.decide.outputs.needs_update }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install DuckDB CLI
        run: |
          curl -LO https://github.com/duckdb/duckdb/releases/download/v1.1.3/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          chmod +x duckdb
          sudo mv duckdb /usr/local/bin/

      - name: Check Overture release
        id: check
        run: |
          chmod +x scripts/check_release.sh
          ./scripts/check_release.sh

      - name: Decide if update needed
        id: decide
        run: |
          if [ "${{ github.event.inputs.force_data_update }}" = "true" ]; then
            echo "Force update requested"
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
          elif [ "${{ steps.check.outputs.release_changed }}" = "true" ]; then
            echo "Release changed, update needed"
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
          else
            echo "No update needed"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          fi

  build-and-diff:
    needs: check-release
    if: needs.check-release.outputs.needs_update == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install DuckDB CLI
        run: |
          curl -LO https://github.com/duckdb/duckdb/releases/download/v1.1.3/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          chmod +x duckdb
          sudo mv duckdb /usr/local/bin/

      - name: Install Python dependencies
        run: pip install duckdb

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install npm dependencies
        run: npm ci

      - name: Download global divisions from Overture
        run: |
          chmod +x scripts/download_divisions.sh
          ./scripts/download_divisions.sh "${{ needs.check-release.outputs.overture_release }}"

      - name: Build divisions index
        run: |
          mkdir -p indexes
          python scripts/build_divisions_index.py

      - name: Fetch production versions
        run: |
          chmod +x scripts/fetch_prod_versions.sh
          ./scripts/fetch_prod_versions.sh prod_versions.csv

      - name: Generate differential update
        run: |
          python scripts/diff_and_update.py \
            indexes/divisions-global.db \
            exports/diff \
            --prod-versions prod_versions.csv \
            --release "${{ needs.check-release.outputs.overture_release }}"

          # Show stats
          cat exports/diff/stats.json

      - name: Check if changes exist
        id: changes
        run: |
          # Validate stats.json exists and has expected structure
          if [ ! -f exports/diff/stats.json ]; then
            echo "Error: stats.json not found"
            exit 1
          fi

          # Validate JSON structure before extracting values
          if ! jq -e '.inserts != null and .updates != null and .deletes != null and .unchanged != null' exports/diff/stats.json > /dev/null 2>&1; then
            echo "Error: stats.json missing required fields"
            cat exports/diff/stats.json
            exit 1
          fi

          INSERTS=$(jq '.inserts' exports/diff/stats.json)
          UPDATES=$(jq '.updates' exports/diff/stats.json)
          DELETES=$(jq '.deletes' exports/diff/stats.json)
          TOTAL=$((INSERTS + UPDATES + DELETES))

          echo "Total changes: $TOTAL (inserts: $INSERTS, updates: $UPDATES, deletes: $DELETES)"

          if [ "$TOTAL" -eq 0 ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload diff artifacts
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: diff-sql
          path: exports/diff/
          retention-days: 1

      - name: Upload full index (for fallback)
        uses: actions/upload-artifact@v4
        with:
          name: divisions-index
          path: indexes/divisions-global.db
          retention-days: 1

    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}

  apply-updates:
    needs: [check-release, build-and-diff]
    if: needs.build-and-diff.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download diff artifacts
        uses: actions/download-artifact@v4
        with:
          name: diff-sql
          path: exports/diff/

      - name: Download full index (for initial deployment)
        uses: actions/download-artifact@v4
        with:
          name: divisions-index
          path: indexes/

      - name: Show diff stats
        run: cat exports/diff/stats.json

      - name: Check if initial deployment needed
        id: check-initial
        run: |
          INSERTS=$(jq '.inserts' exports/diff/stats.json)
          UNCHANGED=$(jq '.unchanged' exports/diff/stats.json)
          TOTAL_NEW=$(jq '.total_new' exports/diff/stats.json)

          # Initial deployment: no existing records in production (all are inserts, none unchanged)
          # This avoids arbitrary thresholds - if prod is empty, it's initial deployment
          if [ "$UNCHANGED" -eq 0 ] && [ "$INSERTS" -eq "$TOTAL_NEW" ] && [ "$INSERTS" -gt 0 ]; then
            echo "Initial deployment detected (production is empty, all $INSERTS records are new)"
            echo "initial_deploy=true" >> "$GITHUB_OUTPUT"
          else
            echo "Incremental update (unchanged: $UNCHANGED, inserts: $INSERTS)"
            echo "initial_deploy=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Apply schema (initial deployment)
        if: steps.check-initial.outputs.initial_deploy == 'true'
        run: |
          echo "Creating schema for initial deployment..."
          python scripts/export_to_sql.py \
            indexes/divisions-global.db \
            exports/full \
            --table divisions

          echo "Applying schema..."
          npx wrangler d1 execute geocoder-divisions-global --remote \
            --file=exports/full/schema.sql

      - name: Apply full data (initial deployment)
        if: steps.check-initial.outputs.initial_deploy == 'true'
        run: |
          echo "Uploading full data..."
          for file in exports/full/data-*.sql; do
            echo "Uploading $file..."
            npx wrangler d1 execute geocoder-divisions-global --remote \
              --file="$file"
          done

      - name: Apply upserts to D1 (incremental)
        if: steps.check-initial.outputs.initial_deploy == 'false'
        run: |
          echo "Applying upserts..."
          npx wrangler d1 execute geocoder-divisions-global --remote \
            --file=exports/diff/upserts.sql

      - name: Apply deletes to D1 (incremental)
        if: steps.check-initial.outputs.initial_deploy == 'false'
        run: |
          echo "Applying deletes..."
          npx wrangler d1 execute geocoder-divisions-global --remote \
            --file=exports/diff/deletes.sql

      - name: Update metadata
        run: |
          echo "Updating release metadata..."
          npx wrangler d1 execute geocoder-divisions-global --remote \
            --file=exports/diff/metadata.sql

      - name: Verify update
        run: |
          echo "Verifying update..."
          npx wrangler d1 execute geocoder-divisions-global --remote \
            --command "SELECT * FROM metadata" --json

  deploy-worker:
    needs: [test, check-release, build-and-diff, apply-updates]
    # Run if: tests passed AND one of:
    #   - No data update needed (check-release says no)
    #   - Data update succeeded (apply-updates ran and succeeded)
    #   - No changes to apply (build-and-diff ran, has_changes=false, apply-updates skipped)
    if: |
      always() &&
      needs.test.result == 'success' &&
      (
        needs.check-release.outputs.needs_update == 'false' ||
        needs.apply-updates.result == 'success' ||
        (needs.build-and-diff.result == 'success' && needs.apply-updates.result == 'skipped')
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Deploy Worker
        run: npx wrangler deploy
