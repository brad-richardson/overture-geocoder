name: Data Update

on:
  workflow_dispatch:
    inputs:
      database:
        description: 'Which database to update'
        type: choice
        options:
          - both
          - forward
          - reverse
        default: both
      force_all_upserts:
        description: 'Force ALL records to be upserted (for logic/FTS changes)'
        type: boolean
        default: false

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      overture_release: ${{ steps.check.outputs.overture_release }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install DuckDB CLI
        run: |
          curl -LO https://github.com/duckdb/duckdb/releases/download/v1.1.3/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          chmod +x duckdb
          sudo mv duckdb /usr/local/bin/

      - name: Check Overture release
        id: check
        run: |
          chmod +x scripts/check_release.sh
          ./scripts/check_release.sh

  build-and-diff:
    needs: check-release
    runs-on: ubuntu-latest
    outputs:
      has_forward_changes: ${{ steps.changes.outputs.has_forward_changes }}
      has_reverse_changes: ${{ steps.changes.outputs.has_reverse_changes }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install DuckDB CLI
        run: |
          curl -LO https://github.com/duckdb/duckdb/releases/download/v1.1.3/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          chmod +x duckdb
          sudo mv duckdb /usr/local/bin/

      - name: Install Python dependencies
        run: pip install duckdb

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install npm dependencies
        run: npm ci

      - name: Download global divisions from Overture
        run: |
          chmod +x scripts/download_divisions.sh
          ./scripts/download_divisions.sh "${{ needs.check-release.outputs.overture_release }}"

      - name: Build divisions indexes
        run: |
          mkdir -p indexes
          python scripts/build_divisions_index.py
          python scripts/build_divisions_reverse_index.py

      # ==================== FORWARD GEOCODING ====================
      - name: Fetch production versions (forward)
        if: github.event.inputs.database == 'forward' || github.event.inputs.database == 'both'
        run: |
          chmod +x scripts/fetch_prod_versions.sh
          ./scripts/fetch_prod_versions.sh prod_versions.csv geocoder-divisions-global divisions

      - name: Generate differential update (forward)
        if: github.event.inputs.database == 'forward' || github.event.inputs.database == 'both'
        run: |
          FORCE_ALL_FLAG=""
          if [ "${{ github.event.inputs.force_all_upserts }}" = "true" ]; then
            FORCE_ALL_FLAG="--force-all"
          fi

          python scripts/diff_and_update.py \
            indexes/divisions-global.db \
            exports/diff \
            --prod-versions prod_versions.csv \
            --release "${{ needs.check-release.outputs.overture_release }}" \
            --table divisions \
            $FORCE_ALL_FLAG

          echo "Forward geocoding diff:"
          cat exports/diff/stats.json

      # ==================== REVERSE GEOCODING ====================
      - name: Fetch production versions (reverse)
        if: github.event.inputs.database == 'reverse' || github.event.inputs.database == 'both'
        run: |
          ./scripts/fetch_prod_versions.sh prod_versions_reverse.csv geocoder-divisions-reverse divisions_reverse

      - name: Generate differential update (reverse)
        if: github.event.inputs.database == 'reverse' || github.event.inputs.database == 'both'
        run: |
          FORCE_ALL_FLAG=""
          if [ "${{ github.event.inputs.force_all_upserts }}" = "true" ]; then
            FORCE_ALL_FLAG="--force-all"
          fi

          python scripts/diff_and_update.py \
            indexes/divisions-reverse.db \
            exports/diff-reverse \
            --prod-versions prod_versions_reverse.csv \
            --release "${{ needs.check-release.outputs.overture_release }}" \
            --table divisions_reverse \
            $FORCE_ALL_FLAG

          echo "Reverse geocoding diff:"
          cat exports/diff-reverse/stats.json

      - name: Check if changes exist
        id: changes
        run: |
          # Check forward geocoding changes
          if [ -f exports/diff/stats.json ]; then
            FWD_INSERTS=$(jq '.inserts' exports/diff/stats.json)
            FWD_UPDATES=$(jq '.updates' exports/diff/stats.json)
            FWD_DELETES=$(jq '.deletes' exports/diff/stats.json)
            FWD_TOTAL=$((FWD_INSERTS + FWD_UPDATES + FWD_DELETES))
            echo "Forward changes: $FWD_TOTAL"
            if [ "$FWD_TOTAL" -gt 0 ]; then
              echo "has_forward_changes=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_forward_changes=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "has_forward_changes=false" >> "$GITHUB_OUTPUT"
          fi

          # Check reverse geocoding changes
          if [ -f exports/diff-reverse/stats.json ]; then
            REV_INSERTS=$(jq '.inserts' exports/diff-reverse/stats.json)
            REV_UPDATES=$(jq '.updates' exports/diff-reverse/stats.json)
            REV_DELETES=$(jq '.deletes' exports/diff-reverse/stats.json)
            REV_TOTAL=$((REV_INSERTS + REV_UPDATES + REV_DELETES))
            echo "Reverse changes: $REV_TOTAL"
            if [ "$REV_TOTAL" -gt 0 ]; then
              echo "has_reverse_changes=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_reverse_changes=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "has_reverse_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload diff artifacts (forward)
        if: steps.changes.outputs.has_forward_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: diff-sql
          path: exports/diff/
          retention-days: 1

      - name: Upload diff artifacts (reverse)
        if: steps.changes.outputs.has_reverse_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: diff-sql-reverse
          path: exports/diff-reverse/
          retention-days: 1

  apply-updates:
    needs: [check-release, build-and-diff]
    if: needs.build-and-diff.outputs.has_forward_changes == 'true' || needs.build-and-diff.outputs.has_reverse_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download diff artifacts (forward)
        if: needs.build-and-diff.outputs.has_forward_changes == 'true'
        uses: actions/download-artifact@v4
        with:
          name: diff-sql
          path: exports/diff/

      - name: Download diff artifacts (reverse)
        if: needs.build-and-diff.outputs.has_reverse_changes == 'true'
        uses: actions/download-artifact@v4
        with:
          name: diff-sql-reverse
          path: exports/diff-reverse/

      # ==================== FORWARD GEOCODING ====================
      - name: Apply forward geocoding updates
        if: needs.build-and-diff.outputs.has_forward_changes == 'true'
        uses: ./.github/actions/apply-d1-updates
        with:
          database-name: geocoder-divisions-global
          diff-path: exports/diff
          has-changes: 'true'

      # ==================== REVERSE GEOCODING ====================
      - name: Apply reverse geocoding updates
        if: needs.build-and-diff.outputs.has_reverse_changes == 'true'
        uses: ./.github/actions/apply-d1-updates
        with:
          database-name: geocoder-divisions-reverse
          diff-path: exports/diff-reverse
          has-changes: 'true'

      # ==================== VERIFY ====================
      - name: Verify updates
        run: |
          echo "Verifying forward geocoding..."
          npx wrangler d1 execute geocoder-divisions-global --remote --command "SELECT * FROM metadata" --json || true
          npx wrangler d1 execute geocoder-divisions-global --remote --command "SELECT COUNT(*) as count FROM divisions" --json || true

          echo "Verifying reverse geocoding..."
          npx wrangler d1 execute geocoder-divisions-reverse --remote --command "SELECT * FROM metadata" --json || true
          npx wrangler d1 execute geocoder-divisions-reverse --remote --command "SELECT COUNT(*) as count FROM divisions_reverse" --json || true
