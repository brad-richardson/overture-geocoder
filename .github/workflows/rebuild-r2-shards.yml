name: Rebuild R2 Shards

on:
  workflow_dispatch:
    inputs:
      countries:
        description: 'Comma-separated country codes (empty = all countries)'
        type: string
        required: false
        default: ''
      head_threshold:
        description: 'Population threshold for HEAD shard'
        type: number
        required: false
        default: 100000
      build_type:
        description: 'What to build'
        type: choice
        required: true
        default: 'both'
        options:
          - forward
          - reverse
          - both
      confirm:
        description: 'Type "REBUILD" to confirm'
        type: string
        required: true

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  rebuild-shards:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'REBUILD'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install DuckDB CLI
        run: |
          curl -L -o duckdb.zip https://github.com/duckdb/duckdb/releases/download/v1.1.3/duckdb_cli-linux-amd64.zip
          unzip duckdb.zip
          sudo mv duckdb /usr/local/bin/
          duckdb --version

      - name: Install Python dependencies
        run: pip install duckdb

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Download divisions data
        run: ./scripts/download_divisions.sh

      - name: Build forward geocoding shards
        if: github.event.inputs.build_type == 'forward' || github.event.inputs.build_type == 'both'
        run: |
          ARGS="--head-threshold ${{ github.event.inputs.head_threshold }}"
          if [ -n "${{ github.event.inputs.countries }}" ]; then
            ARGS="$ARGS --countries ${{ github.event.inputs.countries }}"
          fi
          python scripts/build_shards.py $ARGS

      - name: Build reverse geocoding shards
        if: github.event.inputs.build_type == 'reverse' || github.event.inputs.build_type == 'both'
        run: |
          ARGS="--reverse --head-threshold ${{ github.event.inputs.head_threshold }}"
          if [ -n "${{ github.event.inputs.countries }}" ]; then
            ARGS="$ARGS --countries ${{ github.event.inputs.countries }}"
          fi
          python scripts/build_shards.py $ARGS

      - name: Get version
        id: version
        run: |
          VERSION=$(ls -1 shards/ | grep -E '^[0-9]{4}-[0-9]{2}-[0-9]{2}\.[0-9]+$' | sort -r | head -1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Built version: $VERSION"

      - name: Upload forward shards to R2
        if: github.event.inputs.build_type == 'forward' || github.event.inputs.build_type == 'both'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PROGRESS_DIR=$(mktemp -d)
          ERRORS_DIR=$(mktemp -d)

          # Upload catalog
          wrangler r2 object put geocoder-shards/catalog.json \
            --file shards/catalog.json --remote > /dev/null

          # Upload forward geocoding collection
          wrangler r2 object put "geocoder-shards/${VERSION}/collection.json" \
            --file "shards/${VERSION}/collection.json" --remote > /dev/null

          # Count total files
          TOTAL_DB=$(find "shards/${VERSION}/shards" -name "*.db" | wc -l)
          TOTAL_ITEMS=$(find "shards/${VERSION}/items" -name "*.json" | wc -l)
          echo "Uploading ${TOTAL_DB} forward shard databases..."

          # Upload function with progress tracking
          upload_file() {
            local file="$1"
            local version="$2"
            local r2_path="$3"
            local progress_dir="$4"
            local errors_dir="$5"
            local filename=$(basename "$file")

            if output=$(wrangler r2 object put "geocoder-shards/${r2_path}" --file "$file" --remote 2>&1); then
              touch "${progress_dir}/${filename}"
            else
              echo "$output" > "${errors_dir}/${filename}.log"
              touch "${progress_dir}/${filename}"
            fi
          }
          export -f upload_file
          export CLOUDFLARE_API_TOKEN CLOUDFLARE_ACCOUNT_ID

          # Upload databases with progress
          find "shards/${VERSION}/shards" -name "*.db" | \
            xargs -P 8 -I {} bash -c "upload_file '{}' '${VERSION}' '${VERSION}/shards/\$(basename {})' '${PROGRESS_DIR}' '${ERRORS_DIR}'" &

          # Show progress while uploading
          while [ $(find "$PROGRESS_DIR" -type f 2>/dev/null | wc -l) -lt "$TOTAL_DB" ]; do
            DONE=$(find "$PROGRESS_DIR" -type f 2>/dev/null | wc -l)
            printf "\r  Progress: %d/%d databases" "$DONE" "$TOTAL_DB"
            sleep 1
          done
          wait
          printf "\r  Progress: %d/%d databases ✓\n" "$TOTAL_DB" "$TOTAL_DB"

          # Check for errors
          if [ "$(ls -A $ERRORS_DIR 2>/dev/null)" ]; then
            echo "::error::Some uploads failed:"
            cat "$ERRORS_DIR"/*.log
            exit 1
          fi

          # Reset progress for items
          rm -f "$PROGRESS_DIR"/*
          echo "Uploading ${TOTAL_ITEMS} forward item metadata..."

          find "shards/${VERSION}/items" -name "*.json" | \
            xargs -P 8 -I {} bash -c "upload_file '{}' '${VERSION}' '${VERSION}/items/\$(basename {})' '${PROGRESS_DIR}' '${ERRORS_DIR}'" &

          while [ $(find "$PROGRESS_DIR" -type f 2>/dev/null | wc -l) -lt "$TOTAL_ITEMS" ]; do
            DONE=$(find "$PROGRESS_DIR" -type f 2>/dev/null | wc -l)
            printf "\r  Progress: %d/%d items" "$DONE" "$TOTAL_ITEMS"
            sleep 1
          done
          wait
          printf "\r  Progress: %d/%d items ✓\n" "$TOTAL_ITEMS" "$TOTAL_ITEMS"

          if [ "$(ls -A $ERRORS_DIR 2>/dev/null)" ]; then
            echo "::error::Some uploads failed:"
            cat "$ERRORS_DIR"/*.log
            exit 1
          fi

          rm -rf "$PROGRESS_DIR" "$ERRORS_DIR"

      - name: Upload reverse shards to R2
        if: github.event.inputs.build_type == 'reverse' || github.event.inputs.build_type == 'both'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PROGRESS_DIR=$(mktemp -d)
          ERRORS_DIR=$(mktemp -d)

          # Upload reverse geocoding collection
          wrangler r2 object put "geocoder-shards/${VERSION}/reverse-collection.json" \
            --file "shards/${VERSION}/reverse-collection.json" --remote > /dev/null

          # Count total files
          TOTAL_DB=$(find "shards/${VERSION}/reverse" -name "*.db" | wc -l)
          TOTAL_ITEMS=$(find "shards/${VERSION}/reverse-items" -name "*.json" | wc -l)
          echo "Uploading ${TOTAL_DB} reverse shard databases..."

          upload_file() {
            local file="$1"
            local version="$2"
            local r2_path="$3"
            local progress_dir="$4"
            local errors_dir="$5"
            local filename=$(basename "$file")

            if output=$(wrangler r2 object put "geocoder-shards/${r2_path}" --file "$file" --remote 2>&1); then
              touch "${progress_dir}/${filename}"
            else
              echo "$output" > "${errors_dir}/${filename}.log"
              touch "${progress_dir}/${filename}"
            fi
          }
          export -f upload_file
          export CLOUDFLARE_API_TOKEN CLOUDFLARE_ACCOUNT_ID

          find "shards/${VERSION}/reverse" -name "*.db" | \
            xargs -P 8 -I {} bash -c "upload_file '{}' '${VERSION}' '${VERSION}/reverse/\$(basename {})' '${PROGRESS_DIR}' '${ERRORS_DIR}'" &

          while [ $(find "$PROGRESS_DIR" -type f 2>/dev/null | wc -l) -lt "$TOTAL_DB" ]; do
            DONE=$(find "$PROGRESS_DIR" -type f 2>/dev/null | wc -l)
            printf "\r  Progress: %d/%d databases" "$DONE" "$TOTAL_DB"
            sleep 1
          done
          wait
          printf "\r  Progress: %d/%d databases ✓\n" "$TOTAL_DB" "$TOTAL_DB"

          if [ "$(ls -A $ERRORS_DIR 2>/dev/null)" ]; then
            echo "::error::Some uploads failed:"
            cat "$ERRORS_DIR"/*.log
            exit 1
          fi

          rm -f "$PROGRESS_DIR"/*
          echo "Uploading ${TOTAL_ITEMS} reverse item metadata..."

          find "shards/${VERSION}/reverse-items" -name "*.json" | \
            xargs -P 8 -I {} bash -c "upload_file '{}' '${VERSION}' '${VERSION}/reverse-items/\$(basename {})' '${PROGRESS_DIR}' '${ERRORS_DIR}'" &

          while [ $(find "$PROGRESS_DIR" -type f 2>/dev/null | wc -l) -lt "$TOTAL_ITEMS" ]; do
            DONE=$(find "$PROGRESS_DIR" -type f 2>/dev/null | wc -l)
            printf "\r  Progress: %d/%d items" "$DONE" "$TOTAL_ITEMS"
            sleep 1
          done
          wait
          printf "\r  Progress: %d/%d items ✓\n" "$TOTAL_ITEMS" "$TOTAL_ITEMS"

          if [ "$(ls -A $ERRORS_DIR 2>/dev/null)" ]; then
            echo "::error::Some uploads failed:"
            cat "$ERRORS_DIR"/*.log
            exit 1
          fi

          rm -rf "$PROGRESS_DIR" "$ERRORS_DIR"

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_TYPE="${{ github.event.inputs.build_type }}"

          echo "## R2 Shards Rebuild Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Build type:** ${BUILD_TYPE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$BUILD_TYPE" = "forward" ] || [ "$BUILD_TYPE" = "both" ]; then
            echo "### Forward Geocoding Shards" >> $GITHUB_STEP_SUMMARY
            echo "**Count:** $(ls -1 shards/${VERSION}/shards/*.db 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
            echo "**Size:** $(du -sh shards/${VERSION}/shards/ 2>/dev/null | cut -f1 || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$BUILD_TYPE" = "reverse" ] || [ "$BUILD_TYPE" = "both" ]; then
            echo "### Reverse Geocoding Shards" >> $GITHUB_STEP_SUMMARY
            echo "**Count:** $(ls -1 shards/${VERSION}/reverse/*.db 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
            echo "**Size:** $(du -sh shards/${VERSION}/reverse/ 2>/dev/null | cut -f1 || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          fi
