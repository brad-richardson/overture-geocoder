name: Schema Apply - Reverse Geocoding

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "REBUILD" to confirm (tables will be dropped and recreated empty)'
        type: string
        required: true

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "REBUILD" ]; then
            echo "Error: You must type 'REBUILD' to confirm this destructive operation"
            exit 1
          fi
          echo "Confirmation validated. Proceeding with schema apply..."

  apply-schema:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install npm dependencies
        run: npm ci

      - name: Generate schema SQL
        run: |
          mkdir -p exports/schema
          python3 << 'EOF'
          from scripts.export_to_sql import get_divisions_reverse_schema
          with open('exports/schema/schema.sql', 'w') as f:
              f.write(get_divisions_reverse_schema())
          EOF

      - name: Apply schema (DROP + CREATE)
        run: |
          echo "Dropping and recreating reverse geocoding tables..."
          npx wrangler d1 execute geocoder-divisions-reverse \
            --remote \
            --file=exports/schema/schema.sql

      - name: Verify schema
        run: |
          echo "Verifying schema..."
          npx wrangler d1 execute geocoder-divisions-reverse --remote --command "SELECT name FROM sqlite_master WHERE type='table'" --json
          npx wrangler d1 execute geocoder-divisions-reverse --remote --command "SELECT COUNT(*) as count FROM divisions_reverse" --json

      - name: Next steps
        run: |
          echo ""
          echo "Schema applied successfully!"
          echo ""
          echo "Next steps to populate data:"
          echo "  1. Go to Actions > Data Update"
          echo "  2. Run with force_all_upserts=true"
          echo ""
